"use strict";

var db = require('db/db.js')
    , RsyncConfig = require('rsync/rsync-command/rsync-config')
    , _ = require('underscore');

var rsyncRepository = {

    /**
     * @param rsyncConfig {RsyncConfig}
     * @param callback {function(String, RsyncConfig)}
     */
    save: function save(rsyncConfig, callback) {
        if (!rsyncConfig || rsyncConfig.constructor.prototype !== RsyncConfig.prototype) {
            callback('RsyncConfig is required', null);
        } else if (rsyncConfig._id) {
            db.update({_id: rsyncConfig._id}, rsyncConfig, {}, function (error, replaceCount) {
                if (replaceCount !== 1) {
                    callback('Rsync config could not be updated - ' + error, null);
                } else {
                    callback(error, rsyncConfig);
                }
            })
        } else {
            this.getByRsyncConfigName(rsyncConfig.rsyncConfigName, function (error, duplicateRsyncConfig) {
                if (error) {
                    callback(error, null);
                } else if (duplicateRsyncConfig) {
                    callback("A rsync config with name '" + rsyncConfig.rsyncConfigName + "' already exists", null);
                } else {
                    db.insert(rsyncConfig, callback);
                }

            });
        }
    },

    /**
     * @param callback {function(String, RsyncConfig[])}
     */
    findAll: function findAll(callback) {
        db.find({rsyncConfigName: {$exists: true}}, function (error, rsyncConfigs) {
            _.each(rsyncConfigs, function (rsyncConfig) {
                rsyncConfig.__proto__ = RsyncConfig.prototype;
            });
            callback(error, rsyncConfigs);
        });
    },

    /**
     * @param rsyncConfigName {String}
     * @param callback {function(String, RsyncConfig)}
     */
    getByRsyncConfigName: function getByRsyncConfigName(rsyncConfigName, callback) {
        db.find({rsyncConfigName: rsyncConfigName}, function (error, rsyncConfigs) {
            if (!rsyncConfigs || rsyncConfigs.length === 0) {
                callback(error, null);
            } else if (rsyncConfigs.length > 1) {
                callback(rsyncConfigs.length + ' rsync configs found with name: ' + rsyncConfigName, null);
            } else {
                var loadedRsyncConfig = rsyncConfigs[0];
                loadedRsyncConfig.__proto__ = RsyncConfig.prototype;
                callback(error, loadedRsyncConfig);
            }
        });
    },

    /**
     * @param id {String}
     * @param callback {function(String, RsyncConfig)}
     */
    getById: function getById(id, callback) {
        db.find({_id: id}, function (error, rsyncConfigs) {
            if (!rsyncConfigs || rsyncConfigs.length === 0) {
                callback(error, null);
            } else {
                var loadedRsyncConfig = rsyncConfigs[0];
                loadedRsyncConfig.__proto__ = RsyncConfig.prototype;
                callback(error, loadedRsyncConfig);
            }
        });
    },

    /**
     * @param id {String}
     * @param callback {function(String)}
     */
    remove: function remove(id, callback) {
        db.remove({_id: id}, {}, function (error) {
            callback(error);
        })
    }
};

module.exports = rsyncRepository;
