"use strict";

var df = require('nodejs-disks')
    , _ = require('underscore')
    , async = require('async');

_.string = require('underscore.string');
_.mixin(_.string.exports());


var getDrives = function (callback) {
    df.drives(function (error, driveNames) {
        if (error) {
            callback(error);
        } else {
            async.map(driveNames, getDriveDetail, callback);
        }
    });
};

var getDriveDetail = function (drive, callback) {
    df.driveDetail(drive, callback);
};

var getDriveForPath = function (path, callback) {
    getDrives(function (error, drives) {
        if (error) {
            callback(error);
        } else {
            console.log("Path: " + path);
            var bestMatch;
            for (var i = 0; i < drives.length; i++) {
                var mountpoint = drives[i].mountpoint;
                console.log("Mountpoint: " + mountpoint);
                if (_.startsWith(path, mountpoint)) {
                    if (bestMatch == undefined || mountpoint.length > bestMatch.mountpoint.length) {
                        bestMatch = drives[i];
                        console.log("BestMatch: " + drives[i]);
                    }
                }
            }
            if (bestMatch) {
                callback(null, bestMatch);
            } else {
                callback('No drive found matching the path: ' + path, null);
            }
        }
    });
};

module.exports.getDrives = getDrives;
module.exports.getDriveDetail = getDriveDetail;
module.exports.getDriveForPath = getDriveForPath;
